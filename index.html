<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuplii - pinnan alla</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo, useCallback } = React;

        // Lucide ikonit
        const Calendar = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const Plus = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Edit2 = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </svg>
        );

        const Trash2 = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        );

        const LogOut = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        );

        const User = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        );

        const Kuplii = () => {
            const [selectedCity, setSelectedCity] = useState('Helsinki');
            const [selectedCategory, setSelectedCategory] = useState('Kaikki');
            const [expandedEvent, setExpandedEvent] = useState(null);
            const [user, setUser] = useState(null);
            const [showLogin, setShowLogin] = useState(false);
            const [showAddEvent, setShowAddEvent] = useState(false);
            const [editingEvent, setEditingEvent] = useState(null);
            const [currentScrollDate, setCurrentScrollDate] = useState(null);
            const [poppedBubbles, setPoppedBubbles] = useState(new Set());
            
            const cityScrollRef = useRef(null);
            const categoryScrollRef = useRef(null);
            const mainScrollRef = useRef(null);
            const preventScrollDateUpdate = useRef(false);

            const cities = ['Turku', 'Tampere', 'Helsinki', 'Oulu', 'Rovaniemi'];
            const categories = ['Kaikki', 'Musiikki', 'Urheilu', 'Kulttuuri', 'Lapset'];

            // Tapahtumat ladataan erillisestä JSON-tiedostosta
            const generateInitialEvents = () => {
                return [];
            };

            const [events, setEvents] = useState(generateInitialEvents());

            // Ladataan tapahtumat JSON-tiedostosta
            useEffect(() => {
                fetch('events.json')
                    .then(response => response.json())
                    .then(data => {
                        // Lisätään ID:t tapahtumille
                        const eventsWithIds = data.map((event, index) => ({
                            ...event,
                            id: index + 1
                        }));
                        setEvents(eventsWithIds);
                    })
                    .catch(error => {
                        console.error('Virhe tapahtumien latauksessa:', error);
                    });
            }, []);

            useEffect(() => {
                const removeOldEvents = () => {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    setEvents(prevEvents => 
                        prevEvents.filter(event => {
                            const eventDate = new Date(event.date);
                            eventDate.setHours(0, 0, 0, 0);
                            return eventDate >= today;
                        })
                    );
                };

                removeOldEvents();
                const interval = setInterval(removeOldEvents, 3600000);
                
                return () => clearInterval(interval);
            }, []);

            const categoryColors = {
                'Jazz': '#4A90E2',
                'Klassinen': '#9B59B6',
                'Rock': '#E74C3C',
                'Pop': '#FF6B9D',
                'Rap': '#34495E',
                'Heavy': '#2C2C2C',
                'Jääkiekko': '#3498DB',
                'Jalkapallo': '#27AE60',
                'Ooppera': '#8E44AD',
                'Teatteri': '#D35400',
                'Komedia': '#F39C12',
                'Elokuva': '#E67E22'
            };

            const getCategoryColor = (category, subcategory) => {
                if (subcategory && categoryColors[subcategory]) {
                    return categoryColors[subcategory];
                }
                return categoryColors[category] || '#95A5A6';
            };

            const formatEventTitle = (title, maxLength = 25) => {
                if (title.length <= maxLength) return title;
                
                const featMatch = title.match(/^([^(feat|ft|&]+)/i);
                if (featMatch && featMatch[1].trim().length <= maxLength) {
                    return featMatch[1].trim() + ' ym.';
                }
                
                if (title.includes('vs.') && title.length <= maxLength + 5) {
                    return title;
                }
                
                return title.substring(0, maxLength).trim() + '...';
            };

            const scrollToCenter = (ref, index) => {
                if (ref.current) {
                    const container = ref.current;
                    const buttons = container.querySelectorAll('button');
                    if (buttons[index]) {
                        const button = buttons[index];
                        button.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                }
            };

            const handleCitySelect = (city, index) => {
                setSelectedCity(city);
                scrollToCenter(cityScrollRef, index);
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
            };

            const handleCategorySelect = (category, index) => {
                setSelectedCategory(category);
                scrollToCenter(categoryScrollRef, index);
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
            };

            // Helper-funktio joka palauttaa tämän päivän YYYY-MM-DD muodossa (paikallinen aika)
            const getTodayString = () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const filteredEvents = useMemo(() => {
                return events
                    .filter(e => e.city === selectedCity)
                    .filter(e => selectedCategory === 'Kaikki' || e.category === selectedCategory)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
            }, [events, selectedCity, selectedCategory]);

            // Luo kalenteripäivät vuodeksi eteenpäin
            const calendarDays = useMemo(() => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;
                
                // Etsi viimeinen tapahtuma
                const lastEventDate = filteredEvents.length > 0 
                    ? new Date(filteredEvents[filteredEvents.length - 1].date)
                    : new Date(today);
                
                // Lisää pari päivää tyhjää tilaa viimeisen tapahtuman jälkeen joustavuutta varten
                const endDate = new Date(lastEventDate);
                endDate.setDate(endDate.getDate() + 3);
                
                // Jos ei tapahtumia, näytä vain pari viikkoa eteenpäin
                if (filteredEvents.length === 0) {
                    endDate.setDate(today.getDate() + 14);
                }
                
                const days = [];
                const currentDate = new Date(today);
                
                while (currentDate <= endDate) {
                    const y = currentDate.getFullYear();
                    const m = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const d = String(currentDate.getDate()).padStart(2, '0');
                    const dateStr = `${y}-${m}-${d}`;
                    const dayEvents = filteredEvents.filter(e => e.date === dateStr);
                    days.push({
                        date: dateStr,
                        events: dayEvents
                    });
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                return days;
            }, [filteredEvents]);

            const handleScroll = () => {
                if (!mainScrollRef.current) return;
                
                const scrollTop = mainScrollRef.current.scrollTop;
                const viewportHeight = mainScrollRef.current.clientHeight;
                // Responsiivinen yläpalkin korkeus
                const topBarHeight = window.innerWidth < 768 ? 80 : 140;
                const bottomNavHeight = 200;
                
                // Lasketaan "aktiivinen alue" näytön keskeltä
                const activeZoneTop = topBarHeight + 150; // 150px yläpalkin jälkeen
                
                // Etsitään päivämäärä joka on aktiivisella alueella
                const dateElements = mainScrollRef.current.querySelectorAll('[data-date]');
                let newActiveDate = null;

                dateElements.forEach(el => {
                    const rect = el.getBoundingClientRect();
                    const containerRect = mainScrollRef.current.getBoundingClientRect();
                    
                    // Elementin sijainti suhteessa containeriin
                    const elementTop = rect.top - containerRect.top;
                    const elementBottom = rect.bottom - containerRect.top;
                    
                    // Jos aktiivinen alue osuu tämän päivän alueelle
                    if (elementTop <= activeZoneTop && elementBottom > activeZoneTop) {
                        newActiveDate = el.getAttribute('data-date');
                    }
                });

                // Päivitetään vain jos muuttunut JA logo-klikkaus ei estä päivitystä
                if (newActiveDate && newActiveDate !== currentScrollDate && !preventScrollDateUpdate.current) {
                    setCurrentScrollDate(newActiveDate);
                }

                // Poppaa kuplia jotka menevät näytön yläreunan yli
                const bubbleElements = mainScrollRef.current.querySelectorAll('[data-event-id]');
                bubbleElements.forEach(el => {
                    const rect = el.getBoundingClientRect();
                    const eventId = parseInt(el.getAttribute('data-event-id'));
                    
                    if (rect.bottom < 0 && !poppedBubbles.has(eventId)) {
                        setPoppedBubbles(prev => new Set([...prev, eventId]));
                        setTimeout(() => {
                            setPoppedBubbles(prev => {
                                const newSet = new Set(prev);
                                newSet.delete(eventId);
                                return newSet;
                            });
                        }, 600);
                    }
                });
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return { day: '', month: '', weekday: '' };
                const date = new Date(dateStr);
                const weekdays = ['Su', 'Ma', 'Ti', 'Ke', 'To', 'Pe', 'La'];
                const months = ['Tammi', 'Helmi', 'Maalis', 'Huhti', 'Touko', 'Kesä', 'Heinä', 'Elo', 'Syys', 'Loka', 'Marras', 'Joulu'];
                
                return {
                    day: date.getDate(),
                    month: months[date.getMonth()],
                    weekday: weekdays[date.getDay()]
                };
            };

            const handleLogin = (username, password) => {
                if (username === 'admin' && password === 'admin') {
                    setUser({ name: 'Admin', role: 'admin' });
                    setShowLogin(false);
                } else if (username && password) {
                    setUser({ name: username, role: 'user' });
                    setShowLogin(false);
                }
            };

            const handleAddEvent = (newEvent) => {
                const isDuplicate = events.some(e => 
                    e.title === newEvent.title && 
                    e.date === newEvent.date && 
                    e.time === newEvent.time &&
                    e.city === newEvent.city
                );

                if (isDuplicate) {
                    alert('Tämä tapahtuma on jo olemassa!');
                    return;
                }

                const event = {
                    ...newEvent,
                    id: Math.max(...events.map(e => e.id), 0) + 1
                };
                setEvents([...events, event]);
                setShowAddEvent(false);
            };

            const handleEditEvent = (updatedEvent) => {
                setEvents(events.map(e => e.id === updatedEvent.id ? updatedEvent : e));
                setEditingEvent(null);
            };

            const handleDeleteEvent = async (id) => {
                if (window.confirm('Haluatko varmasti poistaa tapahtuman?')) {
                    // Remove from UI immediately
                    setEvents(events.filter(e => e.id !== id));
                    setExpandedEvent(null);
                    // Delete from Supabase if it's a DB event
                    if (sb && id.startsWith('db-')) {
                        const dbId = id.replace('db-', '');
                        const { error } = await sb.from('events').delete().eq('id', dbId);
                        if (error) console.error('Delete error:', error.message);
                    }
                }
            };

            useEffect(() => {
                // Viive että elementit ehtivät renderöityä
                setTimeout(() => {
                    const cityIndex = cities.indexOf(selectedCity);
                    const categoryIndex = categories.indexOf(selectedCategory);
                    scrollToCenter(cityScrollRef, cityIndex);
                    scrollToCenter(categoryScrollRef, categoryIndex);
                }, 100);
            }, []);

            useEffect(() => {
                if (filteredEvents.length > 0 && !currentScrollDate) {
                    const today = getTodayString();
                    setCurrentScrollDate(today);
                }
            }, [filteredEvents, currentScrollDate]);

            // Skrollaa tämän päivän kohdalle kun komponentti mountataan
            useEffect(() => {
                if (mainScrollRef.current && calendarDays.length > 0) {
                    const today = getTodayString();
                    const todayElement = mainScrollRef.current.querySelector(`[data-date="${today}"]`);
                    if (todayElement) {
                        setTimeout(() => {
                            todayElement.scrollIntoView({ block: 'start' });
                        }, 100);
                    }
                }
            }, []);

            // Päivitä currentScrollDate kun kupla avataan
            useEffect(() => {
                if (expandedEvent) {
                    const event = filteredEvents.find(e => e.id === expandedEvent);
                    if (event && event.date !== currentScrollDate) {
                        setCurrentScrollDate(event.date);
                    }
                }
            }, [expandedEvent]);

            const dateInfo = formatDate(currentScrollDate);

            return (
                <div className="h-screen flex flex-col relative overflow-hidden" 
                     style={{ 
                         backgroundImage: 'url(tausta.jpg)',
                         backgroundSize: 'cover',
                         backgroundPosition: 'center',
                         backgroundAttachment: 'fixed'
                     }}>
                    {/* Yläpalkki Kuplii-logon värimaailmalla */}
                    <div className="relative p-2 md:p-4 pb-16 md:pb-32 flex justify-end items-start z-20 overflow-visible">
                        {/* Musta lasinen tausta - läpinäkyvämpi */}
                        <div className="absolute inset-0 backdrop-blur-xl border-b border-white/10"
                             style={{ 
                               backgroundColor: 'rgba(0, 0, 0, 0.5)',
                               boxShadow: '0 10px 40px rgba(0,0,0,0.5)'
                             }}>
                        </div>
                        
                        {/* Kuplii logo keskellä, suurin osa alapuolella */}
                        <div 
                            className="absolute left-1/2 top-2 md:top-4 transform -translate-x-1/2 z-30 cursor-pointer"
                            onClick={() => {
                                const today = getTodayString();
                                // Aseta päivämäärä ENSIN
                                setCurrentScrollDate(today);
                                // Estä handleScroll päivittämästä päivää 500ms ajan
                                preventScrollDateUpdate.current = true;
                                setTimeout(() => {
                                    preventScrollDateUpdate.current = false;
                                }, 500);
                                // Sitten skrollaa
                                const todayElement = mainScrollRef.current?.querySelector(`[data-date="${today}"]`);
                                if (todayElement) {
                                    todayElement.scrollIntoView({ behavior: 'auto', block: 'start' });
                                }
                            }}
                        >
                            <img 
                                src="kuplii.png" 
                                alt="Kuplii" 
                                className="w-[120px] h-[120px] md:w-[250px] md:h-[250px] object-contain hover:scale-105 transition-transform"
                            />
                        </div>
                        
                        <div className="flex gap-2 relative z-10">
                            {user && user.role === 'user' && (
                                <button
                                    onClick={() => setShowAddEvent(true)}
                                    className="p-1.5 md:p-2 bg-white/20 hover:bg-white/30 rounded-full transition-colors"
                                    title="Lisää tapahtuma"
                                >
                                    <Plus className="w-4 h-4 md:w-5 md:h-5 text-white" />
                                </button>
                            )}
                            {user ? (
                                <button
                                    onClick={() => setUser(null)}
                                    className="flex items-center gap-1.5 md:gap-2 px-2 md:px-4 py-1.5 md:py-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors"
                                >
                                    <User className="w-3 h-3 md:w-4 md:h-4 text-white" />
                                    <span className="text-xs md:text-sm text-white font-medium">{user.name}</span>
                                    <LogOut className="w-3 h-3 md:w-4 md:h-4 text-white" />
                                </button>
                            ) : (
                                <button
                                    onClick={() => setShowLogin(true)}
                                    className="px-3 md:px-6 py-1.5 md:py-2 bg-white/90 text-purple-700 rounded-full hover:bg-white transition-colors text-xs md:text-sm font-semibold shadow-lg"
                                >
                                    Kirjaudu
                                </button>
                            )}
                        </div>
                    </div>
                    <div className="flex flex-1 relative overflow-hidden">
                        {/* Pääsisältöalue kuplille */}
                        <div 
                            ref={mainScrollRef}
                            onScroll={handleScroll}
                            className="flex-1 relative overflow-y-auto pb-32"
                            style={{ 
                                backgroundImage: 'url(tausta.jpg)',
                                backgroundSize: 'cover',
                                backgroundPosition: 'center',
                                backgroundAttachment: 'fixed'
                            }}
                        >
                            {/* Lasinen blur-efekti taustalle - tyylikkäämmäksi */}
                            <div className="fixed inset-0 pointer-events-none" style={{ top: '140px', zIndex: 0 }}>
                                {/* Gradient overlay + blur */}
                                <div className="absolute inset-0 bg-gradient-to-b from-white/15 via-white/10 to-white/20 backdrop-blur-sm"></div>
                                {/* Hienovarainen noise/texture efekti */}
                                <div className="absolute inset-0 opacity-30" style={{
                                    backgroundImage: 'radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(255,255,255,0.1) 0%, transparent 50%)'
                                }}></div>
                            </div>

                            {/* Iso kalenteripäivä - näkyvämmäksi */}
                            <div className="fixed inset-0 flex items-center justify-center pointer-events-none z-0 opacity-40">
                                <div className="text-center">
                                    <div className="text-9xl font-bold text-gray-900 drop-shadow-lg">{dateInfo.day}</div>
                                    <div className="text-4xl font-semibold text-gray-800 mt-2 drop-shadow-md">{dateInfo.month}</div>
                                    <div className="text-2xl text-gray-700 mt-1 drop-shadow-md">{dateInfo.weekday}</div>
                                </div>
                            </div>

                            {/* Sisältö flex-containerissa */}
                            <div className="flex">
                                {/* Kuplat vasemmalla - jätetään tilaa oikealle kalenterille */}
                                <div className="flex-1 px-4 pt-6 pb-4 relative z-10" style={{ maxWidth: 'calc(100% - 70px)' }}>
                                {calendarDays.map(({ date, events: dayEvents }) => {
                                    // Tarkistetaan onko tämän päivän tapahtumista joku laajennettu
                                    const hasExpandedEvent = dayEvents.some(e => e.id === expandedEvent);
                                    // Jos ei tapahtumia, normaali päivän korkeus
                                    const minHeight = dayEvents.length === 0 
                                        ? 150 
                                        : (hasExpandedEvent 
                                            ? Math.max(400, dayEvents.length * 140) 
                                            : Math.max(200, dayEvents.length * 140));
                                    
                                    // Sekoita tapahtumat satunnaisesti (mutta konsistentisti)
                                    const shuffledEvents = [...dayEvents].sort((a, b) => {
                                        const hashA = (a.id * 2654435761) % 2147483648;
                                        const hashB = (b.id * 2654435761) % 2147483648;
                                        return hashA - hashB;
                                    });
                                    
                                    return (
                                        <div 
                                            key={date}
                                            data-date={date}
                                            className="relative pb-8"
                                            style={{ 
                                                minHeight: `${minHeight}px`,
                                                width: '100%',
                                                overflow: 'visible'
                                            }}
                                        >
                                            {shuffledEvents.map((event, idx) => {
                                                const isExpanded = expandedEvent === event.id;
                                                const isPopping = poppedBubbles.has(event.id);
                                                
                                                // Satunnainen koko perustuen event.id:hen
                                                const sizeVariation = (event.id * 13) % 3;
                                                const baseSize = 80 + sizeVariation * 20;
                                                // Lasketaan skaalauskerroin - isExpanded tilassa 280px, muuten baseSize
                                                const scaleValue = isExpanded ? 280 / baseSize : 1;
                                                const color = getCategoryColor(event.category, event.subcategory);
                                                
                                                // Satunnainen float-viive
                                                const floatDelay = ((event.id * 7) % 10) * 0.3;
                                                
                                                // Satunnainen vaaka-asema - jakautuu leveydelle 0-70% jotta kuplat eivät mene reunojen yli
                                                // Käytetään monipuolista laskentaa jotta kuplat jakautuvat tasaisesti
                                                const randomLeft = ((event.id * 31 + event.id * event.id * 11 + event.id * 67) % 71);
                                                
                                                // Kun kupla avataan, lasketaan optimaalinen sijainti
                                                // Kupla pysyy lähtökohtaisesti paikallaan, mutta siirtyy jos menee reunan yli
                                                const getExpandedPosition = () => {
                                                    if (!isExpanded) return {};
                                                    
                                                    const isMobile = window.innerWidth < 768;
                                                    const bubbleWidth = isMobile ? Math.min(280, window.innerWidth - 80) : 320;
                                                    const calendarWidth = 64; // Oikean reunan kalenteri
                                                    const leftPadding = 16; // px-4 = 16px
                                                    const rightPadding = 16;
                                                    const availableWidth = window.innerWidth - calendarWidth - leftPadding - rightPadding - 20;
                                                    
                                                    // Mobiilissa keskitetään kupla
                                                    if (isMobile) {
                                                        const centerPosition = (availableWidth - bubbleWidth) / 2;
                                                        return {
                                                            marginLeft: `${centerPosition}px`,
                                                            maxWidth: `${bubbleWidth}px`,
                                                            width: `${bubbleWidth}px`
                                                        };
                                                    }
                                                    
                                                    // Desktop: Lasketaan missä kupla olisi normaalisti
                                                    const originalLeftPx = (randomLeft / 100) * availableWidth;
                                                    
                                                    // Jos menee oikealle reunalle yli
                                                    if (originalLeftPx + bubbleWidth > availableWidth) {
                                                        return { 
                                                            marginLeft: `${availableWidth - bubbleWidth}px`,
                                                            maxWidth: '320px',
                                                            width: '320px'
                                                        };
                                                    }
                                                    
                                                    // Jos menee vasemmalle reunalle yli
                                                    if (originalLeftPx < 20) {
                                                        return { 
                                                            marginLeft: '20px',
                                                            maxWidth: '320px',
                                                            width: '320px'
                                                        };
                                                    }
                                                    
                                                    // Muuten pysyy paikallaan
                                                    return { 
                                                        marginLeft: `${randomLeft}%`,
                                                        maxWidth: '320px',
                                                        width: '320px'
                                                    };
                                                };
                                                
                                                const expandedPos = getExpandedPosition();
                                                const isMobile = window.innerWidth < 768;
                                                const expandedSize = isMobile ? Math.min(280, window.innerWidth - 80) : 320;
                                                
                                                return (
                                                    <div
                                                        key={event.id}
                                                        data-event-id={event.id}
                                                        className={`mb-4 ${isPopping ? 'animate-pop' : ''}`}
                                                        style={{
                                                            marginLeft: isExpanded ? expandedPos.marginLeft : `${randomLeft}%`,
                                                            maxWidth: isExpanded ? expandedPos.maxWidth : `${baseSize}px`,
                                                            width: isExpanded ? expandedPos.width : 'auto',
                                                            animation: isPopping ? 'pop 0.6s ease-out forwards' : (isExpanded ? 'none' : 'float 4s ease-in-out infinite'),
                                                            animationDelay: `${floatDelay}s`,
                                                            position: 'relative',
                                                            zIndex: isExpanded ? 1000 : 10,
                                                            transition: 'margin-left 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), max-width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)',
                                                            willChange: isExpanded ? 'margin-left, width, max-width' : 'auto'
                                                        }}
                                                    >
                                                        <div
                                                            onClick={() => {
                                                                if (!isExpanded) {
                                                                    setExpandedEvent(event.id);
                                                                    // Aseta kalenterijanan aktiivinen päivä
                                                                    setCurrentScrollDate(event.date);
                                                                    // Skrollaa kupla näkyviin pienen viiveen jälkeen (animaation ajaksi)
                                                                    setTimeout(() => {
                                                                        const element = document.querySelector(`[data-event-id="${event.id}"]`);
                                                                        if (element && mainScrollRef.current) {
                                                                            const elementRect = element.getBoundingClientRect();
                                                                            const containerRect = mainScrollRef.current.getBoundingClientRect();
                                                                            const bottomNavHeight = 200; // Alapalkin korkeus
                                                                            const topBarHeight = window.innerWidth < 768 ? 80 : 140; // Responsiivinen yläpalkki
                                                                            const bubbleHeight = window.innerWidth < 768 ? Math.min(280, window.innerWidth - 80) : 320;
                                                                            
                                                                            // Tarkista että kupla mahtuu kokonaan näkyviin
                                                                            const visibleTop = containerRect.top + topBarHeight + 20;
                                                                            const visibleBottom = window.innerHeight - bottomNavHeight - 20;
                                                                            const visibleHeight = visibleBottom - visibleTop;
                                                                            
                                                                            // Jos kupla menee alapalkin alle
                                                                            if (elementRect.top + bubbleHeight > visibleBottom) {
                                                                                const scrollAmount = (elementRect.top + bubbleHeight) - visibleBottom;
                                                                                mainScrollRef.current.scrollTo({
                                                                                    top: mainScrollRef.current.scrollTop + scrollAmount,
                                                                                    behavior: 'smooth'
                                                                                });
                                                                            }
                                                                            
                                                                            // Jos kupla menee yläpalkin alle
                                                                            else if (elementRect.top < visibleTop) {
                                                                                const scrollAmount = visibleTop - elementRect.top;
                                                                                mainScrollRef.current.scrollTo({
                                                                                    top: mainScrollRef.current.scrollTop - scrollAmount,
                                                                                    behavior: 'smooth'
                                                                                });
                                                                            }
                                                                        }
                                                                    }, 150);
                                                                } else {
                                                                    setExpandedEvent(null);
                                                                }
                                                            }}
                                                            className="rounded-full cursor-pointer shadow-2xl relative"
                                                            style={{
                                                                width: isExpanded ? `${expandedSize}px` : `${baseSize}px`,
                                                                height: isExpanded ? `${expandedSize}px` : `${baseSize}px`,
                                                                backgroundColor: color,
                                                                opacity: isPopping ? 0 : 0.95,
                                                                boxShadow: isExpanded ? '0 30px 100px rgba(0,0,0,0.5), inset -10px -10px 20px rgba(0,0,0,0.1), inset 10px 10px 20px rgba(255,255,255,0.3)' : '0 8px 32px rgba(0,0,0,0.1), inset -10px -10px 20px rgba(0,0,0,0.1), inset 10px 10px 20px rgba(255,255,255,0.3)',
                                                                overflow: 'visible',
                                                                transition: 'width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), height 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.6s ease-out',
                                                                willChange: isExpanded ? 'width, height' : 'auto'
                                                            }}
                                                        >
                                                            {/* Gradient overlay - fade out kun laajennetaan */}
                                                            <div 
                                                                className="absolute top-0 left-0 w-full h-full rounded-full bg-gradient-to-br from-white/40 via-transparent to-transparent pointer-events-none"
                                                                style={{
                                                                    opacity: isExpanded ? 0 : 1,
                                                                    transition: 'opacity 0.3s ease-out'
                                                                }}
                                                            />
                                                            {/* Valkoinen kiiltopiste - fade out kun laajennetaan */}
                                                            <div 
                                                                className="absolute top-2 left-2 w-8 h-8 rounded-full bg-white blur-sm pointer-events-none"
                                                                style={{
                                                                    opacity: isExpanded ? 0 : 0.5,
                                                                    transition: 'opacity 0.3s ease-out'
                                                                }}
                                                            />
                                                            
                                                            {isExpanded ? (
                                                                <div className="absolute inset-0 flex flex-col items-center justify-start p-8 overflow-y-auto">
                                                                    <h3 className="font-bold text-xl mb-4 leading-tight text-white text-center">{event.title}</h3>
                                                                    <div className="text-sm space-y-3 text-white w-full">
                                                                        <p className="flex items-center justify-center gap-2">
                                                                            <Calendar className="w-4 h-4" />
                                                                            <span>{event.date} klo {event.time}</span>
                                                                        </p>
                                                                        {event.venue && (
                                                                            <p className="font-semibold text-center">{event.venue}</p>
                                                                        )}
                                                                        {event.description && (
                                                                            <p className="mt-3 leading-relaxed text-center opacity-95">{event.description}</p>
                                                                        )}
                                                                        {event.price && (
                                                                            <p className="font-bold mt-3 text-lg text-center">{event.price}</p>
                                                                        )}
                                                                        {event.subcategory && (
                                                                            <p className="text-xs mt-3 text-center">
                                                                                <span className="bg-white/30 backdrop-blur-sm px-3 py-1 rounded-full">{event.subcategory}</span>
                                                                            </p>
                                                                        )}
                                                                    </div>
                                                                    {user && user.role === 'admin' && (
                                                                        <div className="flex gap-3 mt-5">
                                                                            <button
                                                                                onClick={(e) => {
                                                                                    e.stopPropagation();
                                                                                    setEditingEvent(event);
                                                                                    setExpandedEvent(null);
                                                                                }}
                                                                                className="p-3 bg-white/30 hover:bg-white/40 backdrop-blur-sm rounded-full transition-all"
                                                                            >
                                                                                <Edit2 className="w-5 h-5 text-white" />
                                                                            </button>
                                                                            <button
                                                                                onClick={(e) => {
                                                                                    e.stopPropagation();
                                                                                    handleDeleteEvent(event.id);
                                                                                }}
                                                                                className="p-3 bg-red-500/40 hover:bg-red-500/60 backdrop-blur-sm rounded-full transition-all"
                                                                            >
                                                                                <Trash2 className="w-5 h-5 text-white" />
                                                                            </button>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ) : (
                                                            <div className="absolute inset-0 flex flex-col items-center justify-center p-4 text-white text-center overflow-hidden">
                                                                {/* Admin quick-delete X button */}
                                                                {user && userProfile?.role === 'admin' && (
                                                                    <button
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            handleDeleteEvent(event.id);
                                                                        }}
                                                                        className="absolute top-1 right-1 w-5 h-5 flex items-center justify-center rounded-full bg-red-500/70 hover:bg-red-500 text-white text-xs font-bold transition-all z-10"
                                                                        style={{ fontSize: '10px', lineHeight: 1 }}
                                                                    >
                                                                        ✕
                                                                    </button>
                                                                )}
                                                                <>
                                                                    <div 
                                                                        className="font-bold mb-1 px-2 leading-tight"
                                                                        style={{ 
                                                                            fontSize: baseSize < 100 ? '0.7rem' : baseSize < 120 ? '0.8rem' : '0.9rem',
                                                                            display: '-webkit-box',
                                                                            WebkitLineClamp: '2',
                                                                            WebkitBoxOrient: 'vertical',
                                                                            overflow: 'hidden',
                                                                            wordBreak: 'break-word'
                                                                        }}
                                                                    >
                                                                        {event.title.length > 32 ? event.title.substring(0, 32) + '...' : event.title}
                                                                    </div>
                                                                    <div className="text-xs opacity-90">{event.time}</div>
                                                                </>
                                                            </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                })}
                                </div>

                                {/* Kalenterijana oikealla - vierähtää sisällön mukana */}
                                <div className="w-16 min-w-16 max-w-16 bg-gradient-to-l from-white/40 to-transparent backdrop-blur-sm border-l border-gray-200/20 flex-shrink-0" style={{ zIndex: 5, willChange: 'auto' }}>
                                    <div className="py-4 sticky top-0">
                                {calendarDays.map(({ date, events: dayEvents }) => {
                                    const dateObj = new Date(date);
                                    const isCurrentDate = date === currentScrollDate;
                                    // Tarkistetaan onko tämän päivän tapahtumista joku laajennettu
                                    const hasExpandedEvent = dayEvents.some(e => e.id === expandedEvent);
                                    // Jos ei tapahtumia, normaali korkeus
                                    const minHeight = dayEvents.length === 0 
                                        ? 150 
                                        : (hasExpandedEvent 
                                            ? Math.max(400, dayEvents.length * 140) 
                                            : Math.max(200, dayEvents.length * 140));
                                    
                                    return (
                                        <div 
                                            key={date}
                                            className={`flex flex-col items-center py-3 cursor-pointer transition-all ${
                                                isCurrentDate ? 'bg-purple-200/30' : 'hover:bg-purple-100/20'
                                            }`}
                                            style={{ minHeight: `${minHeight}px` }}
                                            onClick={() => {
                                                const dateElement = mainScrollRef.current?.querySelector(`[data-date="${date}"]`);
                                                if (dateElement) {
                                                    dateElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                                }
                                            }}
                                        >
                                            <div className={`text-lg font-bold ${isCurrentDate ? 'text-purple-600' : 'text-gray-600'}`}>
                                                {dateObj.getDate()}
                                            </div>
                                            <div className={`text-[9px] uppercase tracking-wide ${isCurrentDate ? 'text-purple-500' : 'text-gray-400'}`}>
                                                {['Tam', 'Hel', 'Maa', 'Huh', 'Tou', 'Kes', 'Hei', 'Elo', 'Syy', 'Lok', 'Mar', 'Jou'][dateObj.getMonth()]}
                                            </div>
                                            <div className={`text-[9px] mt-1.5 px-1.5 py-0.5 rounded-full ${
                                                isCurrentDate ? 'bg-purple-400 text-white font-medium' : 'bg-gray-100 text-gray-500'
                                            }`}>
                                                {dayEvents.length}
                                            </div>
                                        </div>
                                    );
                                })}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 z-30">
                        <div className="absolute inset-0 bg-black/50 backdrop-blur-xl border-t border-white/10" 
                             style={{ 
                               boxShadow: '0 -10px 40px rgba(0,0,0,0.3)'
                             }}>
                        </div>
                        
                        <div className="relative">
                            <div className="border-b border-white/10 relative">
                                <div className="absolute left-0 top-0 bottom-0 w-16 bg-gradient-to-r from-black/50 to-transparent pointer-events-none z-10" />
                                <div className="absolute right-0 top-0 bottom-0 w-16 bg-gradient-to-l from-black/50 to-transparent pointer-events-none z-10" />
                                
                                <div
                                    ref={categoryScrollRef}
                                    className="flex overflow-x-auto gap-3 px-5 py-3 scrollbar-hide"
                                    style={{ 
                                        scrollSnapType: 'x mandatory',
                                        scrollBehavior: 'smooth',
                                        scrollPaddingLeft: '50%',
                                        scrollPaddingRight: '50%'
                                    }}
                                >
                                    <div className="flex-shrink-0" style={{width: 'calc(50vw - 60px)'}}></div>
                                    {categories.map((category, idx) => (
                                        <button
                                            key={category}
                                            onClick={() => handleCategorySelect(category, idx)}
                                            className={`flex-shrink-0 px-3 md:px-4 py-1.5 md:py-2 rounded-full transition-all text-xs md:text-sm ${
                                                selectedCategory === category
                                                    ? 'bg-purple-400 text-white font-medium'
                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                            }`}
                                            style={{scrollSnapAlign: 'center'}}
                                        >
                                            {category}
                                        </button>
                                    ))}
                                    <div className="flex-shrink-0" style={{width: 'calc(50vw - 60px)'}}></div>
                                </div>
                            </div>

                            <div className="relative">
                                <div className="absolute left-0 top-0 bottom-0 w-16 bg-gradient-to-r from-black/50 to-transparent pointer-events-none z-10" />
                                <div className="absolute right-0 top-0 bottom-0 w-16 bg-gradient-to-l from-black/50 to-transparent pointer-events-none z-10" />
                                
                                <div
                                    ref={cityScrollRef}
                                    className="flex overflow-x-auto gap-3 px-5 py-3 scrollbar-hide"
                                    style={{ 
                                        scrollSnapType: 'x mandatory',
                                        scrollBehavior: 'smooth',
                                        scrollPaddingLeft: '50%',
                                        scrollPaddingRight: '50%'
                                    }}
                                >
                                    <div className="flex-shrink-0" style={{width: 'calc(50vw - 60px)'}}></div>
                                    {cities.map((city, idx) => (
                                        <button
                                            key={city}
                                            onClick={() => handleCitySelect(city, idx)}
                                            className={`flex-shrink-0 px-3 md:px-4 py-1.5 md:py-2 rounded-full transition-all text-xs md:text-sm ${
                                                selectedCity === city
                                                    ? 'bg-blue-400 text-white font-medium'
                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                            }`}
                                            style={{ scrollSnapAlign: 'center' }}
                                        >
                                            {city}
                                        </button>
                                    ))}
                                    <div className="flex-shrink-0" style={{width: 'calc(50vw - 60px)'}}></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showLogin && (
                        <LoginModal
                            onClose={() => setShowLogin(false)}
                            onLogin={handleLogin}
                        />
                    )}

                    {showAddEvent && (
                        <EventFormModal
                            onClose={() => setShowAddEvent(false)}
                            onSave={handleAddEvent}
                            cities={cities}
                            categories={categories.filter(c => c !== 'Kaikki')}
                        />
                    )}

                    {editingEvent && (
                        <EventFormModal
                            event={editingEvent}
                            onClose={() => setEditingEvent(null)}
                            onSave={handleEditEvent}
                            cities={cities}
                            categories={categories.filter(c => c !== 'Kaikki')}
                        />
                    )}

                    <style>{`
                        .scrollbar-hide::-webkit-scrollbar {
                            display: none;
                        }
                        .scrollbar-hide {
                            -ms-overflow-style: none;
                            scrollbar-width: none;
                        }
                        @keyframes float {
                            0%, 100% {
                                transform: translateY(0px);
                            }
                            50% {
                                transform: translateY(-8px);
                            }
                        }
                        @keyframes pop {
                            0% {
                                transform: scale(1);
                                opacity: 0.85;
                            }
                            50% {
                                transform: scale(1.4);
                                opacity: 0.3;
                            }
                            100% {
                                transform: scale(0);
                                opacity: 0;
                            }
                        }
                    `}</style>
                </div>
            );
        };

        const LoginModal = ({ onClose, onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg p-6 max-w-sm w-full">
                        <h2 className="text-xl font-bold mb-4">Kirjaudu sisään</h2>
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            onLogin(username, password);
                        }}>
                            <input
                                type="text"
                                placeholder="Käyttäjänimi"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg mb-3"
                            />
                            <input
                                type="password"
                                placeholder="Salasana"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg mb-4"
                            />
                            <div className="flex gap-2">
                                <button
                                    type="submit"
                                    className="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"
                                >
                                    Kirjaudu
                                </button>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300"
                                >
                                    Peruuta
                                </button>
                            </div>
                        </form>
                        <p className="text-xs text-gray-500 mt-3">
                            Kokeile: admin/admin tai mikä tahansa käyttäjä/salasana
                        </p>
                    </div>
                </div>
            );
        };

        const EventFormModal = ({ event, onClose, onSave, cities, categories }) => {
            const [formData, setFormData] = useState(event || {
                title: '',
                city: cities[0],
                category: categories[0],
                subcategory: '',
                date: '',
                time: '',
                venue: '',
                description: '',
                price: ''
            });

            const handleSubmit = () => {
                if (!formData.title || !formData.date || !formData.time) {
                    alert('Täytä vähintään otsikko, päivämäärä ja aika');
                    return;
                }
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full my-8">
                        <h2 className="text-xl font-bold mb-4">
                            {event ? 'Muokkaa tapahtumaa' : 'Lisää tapahtuma'}
                        </h2>
                        <div className="space-y-3">
                            <input
                                type="text"
                                placeholder="Otsikko (max 50 merkkiä)"
                                value={formData.title}
                                onChange={(e) => setFormData({ ...formData, title: e.target.value.substring(0, 50) })}
                                className="w-full px-3 py-2 border rounded-lg"
                            />
                            <select
                                value={formData.city}
                                onChange={(e) => setFormData({ ...formData, city: e.target.value })}
                                className="w-full px-3 py-2 border rounded-lg"
                            >
                                {cities.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                            <select
                                value={formData.category}
                                onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                                className="w-full px-3 py-2 border rounded-lg"
                            >
                                {categories.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                            <input
                                type="text"
                                placeholder="Alakategoria (Jazz, Rock jne.)"
                                value={formData.subcategory}
                                onChange={(e) => setFormData({ ...formData, subcategory: e.target.value })}
                                className="w-full px-3 py-2 border rounded-lg"
                            />
                            <input
                                type="date"
                                value={formData.date}
                                onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                className="w-full px-3 py-2 border rounded-lg"
                            />
                            <input
                                type="time"
                                value={formData.time}
                                onChange={(e) => setFormData({ ...formData, time: e.target.value })}
                                className="w-full px-3 py-2 border rounded-lg"
                            />
                            <input
                                type="text"
                                placeholder="Paikka"
                                value={formData.venue}
                                onChange={(e) => setFormData({ ...formData, venue: e.target.value })}
                                className="w-full px-3 py-2 border rounded-lg"
                            />
                            <textarea
                                placeholder="Kuvaus"
                                value={formData.description}
                                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                className="w-full px-3 py-2 border rounded-lg"
                                rows="3"
                            />
                            <input
                                type="text"
                                placeholder="Hinta"
                                value={formData.price}
                                onChange={(e) => setFormData({ ...formData, price: e.target.value })}
                                className="w-full px-3 py-2 border rounded-lg"
                            />
                        </div>
                        <div className="flex gap-2 mt-4">
                            <button
                                onClick={handleSubmit}
                                className="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"
                            >
                                Tallenna
                            </button>
                            <button
                                onClick={onClose}
                                className="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300"
                            >
                                Peruuta
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Kuplii />);
    </script>
</body>
</html>